name: Fuzz

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  fuzz:
    name: Fuzzing
    strategy:
        fail-fast: false
        matrix:
            target: [ubuntu-latest, macos-latest, ubuntu-24.04-arm, macos-15-intel]
    runs-on: ${{ matrix.target }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute Cargo.lock hash
        id: cargo-hash
        shell: bash
        run: |
            if [ "$RUNNER_OS" = "Windows" ]; then
                HASH=$(powershell -Command "(Get-FileHash Cargo.lock -Algorithm SHA256).Hash.ToLower()")
            else
                HASH=$(sha256sum Cargo.lock | awk '{print $1}')
            fi
            echo "hash=$HASH" >> "$GITHUB_OUTPUT"
      - uses: actions/cache@v4
        with:
            path: |
              ~/.cargo/bin/
              ~/.cargo/registry/index/
              ~/.cargo/registry/cache/
              ~/.cargo/git/db/
              target/
            key: ${{ matrix.target }}-nightly-cargo-fuzz-${{ steps.cargo-hash.outputs.hash }}
      - name: Install nightly
        id: install
        uses: dtolnay/rust-toolchain@master
        with: 
            toolchain: nightly

      - name: Build Project
        run: cargo +${{ steps.install.outputs.name }} build --release --workspace --verbose
    
      - id: comphash
        name: Calculate compiler hash
        shell: bash
        run: |
            HASH=$(cargo +${{ steps.install.outputs.name }} hash)
            echo "hash=$HASH" >> "$GITHUB_OUTPUT"

      - name: Install cargo-fuzz
        run: cargo +${{ steps.install.outputs.name }} install cargo-fuzz || true

      - name: Run cargo-fuzz for 10 minutes
        id: fuzz
        run: |
          set -euo pipefail

          FUZZ_TARGET=full

          cargo fuzz run $FUZZ_TARGET -- -max_total_time=10 -timeout=10

          ls -t fuzz/corpus/full

      - name: Upload crash artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-crashes-${{ steps.comphash.outputs.hash }}-${{ matrix.target }}
          path: fuzz/artifacts/full/crashes/**/*
      
      - name: Get latest corpus
        if: always()
        id: corpus
        shell: bash
        run: |
          LATEST=$(ls -t fuzz/corpus/full 2>/dev/null | awk 'NR==1 {print $0}')
          echo "latest=fuzz/corpus/full/$LATEST" >> "$GITHUB_OUTPUT"
      
      - name: Upload corpus
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-corpus-${{ steps.comphash.outputs.hash }}-${{ matrix.target }}
          path: ${{ steps.corpus.outputs.latest }}

