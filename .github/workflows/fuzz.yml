name: Fuzz

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  fuzz:
    name: Fuzzing
    strategy:
        fail-fast: false
        matrix:
            target: [ubuntu-latest, macos-latest, windows-latest, ubuntu-24.04-arm, macos-15-intel, windows-11-arm]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute Cargo.lock hash
        id: cargo-hash
        shell: bash
        run: |
            if [ "$RUNNER_OS" = "Windows" ]; then
                HASH=$(powershell -Command "(Get-FileHash Cargo.lock -Algorithm SHA256).Hash.ToLower()")
            else
                HASH=$(sha256sum Cargo.lock | awk '{print $1}')
            fi
            echo "hash=$HASH" >> "$GITHUB_OUTPUT"
      - uses: actions/cache@v4
        with:
            path: |
              ~/.cargo/bin/
              ~/.cargo/registry/index/
              ~/.cargo/registry/cache/
              ~/.cargo/git/db/
              target/
            key: ${{ matrix.target }}-nightly-cargo-fuzz-${{ steps.cargo-hash.outputs.hash }}
      - name: Install nightly
        id: install
        uses: dtolnay/rust-toolchain@master
        with: 
            toolchain: nightly

      - name: Build Project
        run: cargo +${{ steps.install.outputs.name }} build --release --workspace --verbose
    
      - id: comphash
        name: Calculate compiler hash
        shell: bash
        run: |
            HASH=$(cargo +${{ steps.install.outputs.name }} hash)
            echo "hash=$HASH" >> "$GITHUB_OUTPUT"

      - name: Install cargo-fuzz
        run: cargo +${{ steps.install.outputs.name }} install cargo-fuzz

      - name: Run cargo-fuzz for 10 minutes
        id: fuzz
        run: |
          set -euo pipefail

          FUZZ_TARGET=full
          OUTPUT_DIR=fuzz/artifacts/$FUZZ_TARGET

          echo "Starting fuzzing for 10 minutes..."

          # Start cargo-fuzz in background
          cargo fuzz run $FUZZ_TARGET & 
          FUZZ_PID=$!

          # Start 10-minute timer
          (
            sleep 10m
            echo "10 minutes reached, killing fuzzer..."
            kill $FUZZ_PID 2>/dev/null || true
          ) &
          TIMER_PID=$!

          # Wait for fuzz process
          wait $FUZZ_PID
          STATUS=$?

          # Kill timer if fuzz exited early
          kill $TIMER_PID 2>/dev/null || true

          echo "FUZZ_EXIT_STATUS=$STATUS" >> "$GITHUB_OUTPUT"

          if [[ $STATUS -eq 0 ]]; then
            echo "Fuzzer exited cleanly without crashes."
            exit 0
          elif [[ $STATUS -eq 143 || $STATUS -eq 137 ]]; then
            echo "Fuzzing ran full 10 minutes with no crashes."
            exit 0
          else
            echo "Fuzzer crashed with exit code $STATUS."
            exit 1
          fi

      - name: Upload crash artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-crashes-${{ steps.comphash.outputs.hash }}
          path: fuzz/artifacts/full/crashes/**/*

